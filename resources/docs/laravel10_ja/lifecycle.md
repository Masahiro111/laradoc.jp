# リクエストライフサイクル

- [はじめに](#introduction)
- [ライフサイクル概要](#lifecycle-overview)
    - [最初の手順](#first-steps)
    - [HTTP / コンソールカーネル](#http-console-kernels)
    - [サービスプロバイダ](#service-providers)
    - [ルーティング](#routing)
    - [仕上げ](#finishing-up)
- [サービスプロバイダに焦点を当てる](#focus-on-service-providers)

<a name="introduction"></a>
## はじめに

「現実世界」でどんなツールを使う場合でも、そのツールの仕組みがわかっていると自信を持って使えます。アプリケーション開発も同じです。開発ツールの機能を理解していれば、それらを使うのに快適に自信を持って使用できるようになります。

このドキュメントの目的は、Laravel フレームワークの仕組みを高レベルで概観することです。フレームワーク全体をよりよく理解することで、すべてが「魔法のように」感じることがなくなり、アプリケーションの構築に自信を持てるようになります。すぐにすべての用語を理解できなくても落胆しないでください！まずは何が起こっているのかを基本的に理解しようと努力し、他のドキュメントのセクションを調べていくうちに知識が増えていきます。

<a name="lifecycle-overview"></a>
## ライフサイクル概要

<a name="first-steps"></a>
### 最初の手順

Laravel アプリケーションへのすべてのリクエストのエントリポイントは、`public/index.php`ファイルです。すべてのリクエストは、Web サーバー（Apache / Nginx）の設定によってこのファイルに向けられます。`index.php` ファイルにはあまりコードが含まれていません。むしろ、フレームワークの残りの部分をロードするための出発点です。

`index.php`ファイルは、Composer が生成したオートローダ定義を読み込み、`bootstrap/app.php` からLaravel アプリケーションのインスタンスを取得します。Laravel 自体が最初に行うアクションは、アプリケーション / [サービス コンテナ](/docs/{{version}}/container) のインスタンスを作成することです。

<a name="http-console-kernels"></a>
### HTTP / コンソールカーネル

次に、入ってくるリクエストは、アプリケーションに入るリクエストのタイプに応じて、HTTP カーネルまたはコンソールカーネルに送信されます。これら2つのカーネルは、すべてのリクエストが通過する中心的な場所として機能します。ここでは `app/Http/Kernel.php` にある HTTP カーネルに注目しましょう。

HTTP カーネルは `Illuminate\Foundation\Http\Kernel` クラスを拡張し、リクエストが実行される前に実行される `bootstrappers` の配列を定義します。これらのブートストラッパは、エラー処理の設定、ログの設定、[アプリケーション環境の検出](/docs/{{version}}/configuration#environment-configuration) 、およびリクエストが実際に処理される前に実行する必要があるその他のタスクを実行します。通常、これらのクラスは、あなたが気にする必要のない Laravel の内部構成を処理します。

HTTP カーネルは、すべてのリクエストがアプリケーションによって処理される前に通過する必要がある HTTP [ミドルウェア](/docs/{{version}}/middleware) のリストも定義します。 これらのミドルウェアは、[HTTP セッション](/docs/{{version}}/session) の読み取りと書き込みを処理し、アプリケーションがメンテナンス モードであるかどうかを判断し、[CSRF トークンを確認します](/docs/{{version}}/csrf ) 。これらについては後ほど詳しく説明します。

HTTP カーネルの `handle` メソッドの引数は非常にシンプルです。`Request` を受け取り、`Response` を返します。カーネルは、アプリケーション全体を表す大きなブラックボックスだと考えてください。HTTP リクエストを取り込めば、HTTP レスポンスが返ってきます。

<a name="service-providers"></a>
### サービスプロバイダ

カーネルの初期起動処理の中で最も重要なのが、アプリケーションの [サービス プロバイダー](/docs/{{version}}/providers) をロードすることです。サービスプロバイダは、データベース、キュー、バリデーション、ルーティングなどのさまざまなフレームワークコンポーネントのすべてを初期起動処理する役割を担っています。アプリケーションのすべてのサービスプロバイダは、`config/app.php` 構成ファイルの `providers` 配列で設定されています。

Laravelは、このプロバイダのリストを反復処理し、それぞれをインスタンス化します。プロバイダをインスタンス化した後、すべてのプロバイダの `register` メソッドが呼び出されます。次に、すべてのプロバイダが登録された後、各プロバイダで `boot` メソッドが呼び出されます。 これは、`boot` メソッドが実行されるまでに、登録済みで利用可能なすべてのコンテナバインディングに依存する可能性があるためです。

Laravel が提供する、ほぼすべての主要な機能は、サービスプロバイダによって初期起動および設定されます。フレームワークが提供する多くの機能を初期起動および設定するため、サービスプロバイダは、Laravel の初期起動プロセス全体の最も重要な側面です。

<a name="routing"></a>
### ルーティング

アプリケーションで最も重要なサービスプロバイダの１つは、`App\Providers\RouteServiceProvider` です。このサービスプロバイダは、アプリケーションの `routes` ディレクトリに含まれるルートファイルをロードします。`RouteServiceProvider` のコードを開いて、どのように機能するか見てみましょう！

アプリケーションが初期起動され、すべてのサービスプロバイダが登録されると、`Request` がルータに渡されてディスパッチされます。ルータは、ルートまたはコントローラにリクエストをディスパッチし、ルート固有のミドルウェアを実行します。

ミドルウェアは、アプリケーションに入る HTTP リクエストをフィルタリングまたは検査する便利な仕組みを提供しています。たとえば、Laravel には、アプリケーションのユーザーが認証されているかどうかを確認するミドルウェアが含まれています。ユーザーが認証されていない場合、このミドルウェアはユーザーをログイン画面にリダイレクトします。ただし、ユーザーが認証されている場合、ミドルウェアはリクエストをアプリケーションにさらに進めることを許可します。HTTP カーネルの `$middleware` プロパティの定義を見てみると、アプリケーション内のすべてのルートに割り当てられているミドルウェアもあれば、特定のルートまたはルートグループにのみ割り当てられているミドルウェアもあります。ミドルウェアについての詳細は、[ミドルウェア ドキュメント](/docs/{{version}}/middleware) をお読みください。

一致したルートに割り当てられたすべてのミドルウェアをリクエストが通過する場合、ルートまたはコントローラー メソッドが実行され、ルートまたはコントローラー メソッドによって返された応答が、ルートのミドルウェア チェーンを介して送り返されます。
リクエストがマッチしたルートの割り当てられたすべてのミドルウェアを通過すると、ルートまたはコントローラーメソッドが実行され、ルートまたはコントローラーメソッドから返されたレスポンスがルートのミドルウェアチェーンを通って送信されます。

<a name="finishing-up"></a>
### 仕上げ

ルートまたはコントローラーメソッドがレスポンスを返すと、レスポンスはルートのミドルウェアを通って外側に戻り、アプリケーションが送信されるレスポンスを変更または検査する機会を与えます。

最後に、応答がミドルウェアを通過すると、HTTP カーネルの「handle」メソッドが応答オブジェクトを返し、「index.php」ファイルが返された応答に対して「send」メソッドを呼び出します。 `send` メソッドは、応答コンテンツをユーザーの Web ブラウザーに送信します。 これで、Laravel リクエストのライフサイクル全体を通しての旅が終わりました!
最後に、レスポンスがミドルウェアを通過すると、HTTP カーネルの `handle` メソッドがレスポンスオブジェクトを返し、`index.php` ファイルは返されたレスポンスに対して `send` メソッドを呼び出します。`send` メソッドは、レスポンスコンテンツをユーザーの Web ブラウザに送信します。これで、Laravel リクエストライフサイクルの全体を通じた旅が終了しました！

<a name="focus-on-service-providers"></a>
## サービスプロバイダーに焦点を当てる

サービスプロバイダは、Laravel アプリケーションを初期起動をするための鍵となります。 アプリケーションインスタンスが作成され、サービスプロバイダが登録され、リクエストが初期起動を完了したアプリケーションに渡されます。 簡単ですね！

Laravel アプリケーションがどのように構築され、サービスプロバイダを経由して初期起動されるかをしっかりと把握することは、非常に価値があります。 アプリケーションのデフォルトのサービスプロバイダは、`app/Providers` ディレクトリに保存されます。

デフォルトでは、`AppServiceProvider `のほとんどは空です。このプロバイダは、アプリケーション独自の初期起動処理とサービスコンテナー結合を追加するのに適した場所です。 大規模なアプリケーションの場合は、アプリケーションで使用される特定のサービスに対して、より細かい初期起動処理を行う複数のサービスプロバイダを作成することが望ましいかもしれません。
